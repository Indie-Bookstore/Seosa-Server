# github workflow
name: Deploy To EC2

on:
  push:
    branches:
      - deploy

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Github Repository íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: JDK 17ë²„ì „ ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: application.yml íŒŒì¼ ë§Œë“¤ê¸°
        run: |
          cd ./seosa/src/main
          mkdir resources
          cd resources
          echo "${{ secrets.APPLICATION_PROPERTIES }}" > application.yml

      - name: í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œí•˜ê¸°
        run: |
          cd ./seosa
          ./gradlew clean build

      - name: AWS Resourceì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ AWS credentials ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-2
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: ECRì— ë¡œê·¸ì¸í•˜ê¸°
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        
      - name: Docker ì´ë¯¸ì§€ ìƒì„±
        run: |
          cd ./seosa
          docker build -t seosa-server .

      - name: Docker ì´ë¯¸ì§€ì— Tag ë¶™ì´ê¸°
        run: |
          cd ./seosa
          docker tag seosa-server ${{ steps.login-ecr.outputs.registry }}/seosa-server:latest

      - name: ECRì— Docker ì´ë¯¸ì§€ Pushí•˜ê¸°
        run: |
          cd ./seosa
          docker push ${{ steps.login-ecr.outputs.registry }}/seosa-server:latest

      - name: SSHë¡œ EC2ì— ì ‘ì†í•˜ì—¬ ë°°í¬ ë° ìƒíƒœ í™•ì¸
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            echo "ğŸ”„ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

            # Redis ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ìœ ì§€)
            if docker ps -q --filter "name=seosa-redis" | grep -q .; then
              echo "âœ… Redisê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            else
              echo "ğŸš€ Redis ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
              docker run -d --name seosa-redis -p 6379:6379 redis:latest
            fi

            # ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            echo "ğŸ›‘ ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¤‘ì§€í•˜ê³  ì‚­ì œí•©ë‹ˆë‹¤..."
            docker stop seosa-server || true
            docker rm seosa-server || true

            # ìµœì‹  Docker ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            echo "â¬‡ï¸ ìµœì‹  ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤..."
            docker pull ${{ steps.login-ecr.outputs.registry }}/seosa-server:latest

            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (Redisì™€ ì—°ê²°)
            echo "ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
            docker run -d --name seosa-server --link seosa-redis -p 8080:8080 \
              -e SPRING_REDIS_HOST=seosa-redis \
              -e SPRING_REDIS_PORT=6379 \
              ${{ steps.login-ecr.outputs.registry }}/seosa-server:latest

            echo "âœ… ë°°í¬ ì™„ë£Œ! ì‹¤í–‰ ìƒíƒœ í™•ì¸ì„ ì‹œì‘í•©ë‹ˆë‹¤..."

            # âœ… Redis ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ” Redis ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
            if docker ps | grep -q seosa-redis; then
              echo "âœ… Redisê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
            else
              echo "âŒ Redisê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤! ë°°í¬ ì‹¤íŒ¨!"
              exit 1
            fi

            # âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
            if docker ps | grep -q seosa-server; then
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
            else
              echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤! ë°°í¬ ì‹¤íŒ¨!"
              exit 1
            fi

            # âœ… Redis PING í…ŒìŠ¤íŠ¸
            echo "ğŸ”„ Redis PING í…ŒìŠ¤íŠ¸ ì¤‘..."
            REDIS_PING=$(docker exec seosa-redis redis-cli ping)
            if [ "$REDIS_PING" = "PONG" ]; then
              echo "âœ… Redisê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤!"
            else
              echo "âŒ Redisì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤! ë°°í¬ ì‹¤íŒ¨!"
              exit 1
            fi

            # âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ ì¶œë ¥ (ìµœê·¼ 20ì¤„)
            echo "ğŸ“œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ ì¶œë ¥ (ìµœê·¼ 20ì¤„)"
            docker logs --tail 20 seosa-server
